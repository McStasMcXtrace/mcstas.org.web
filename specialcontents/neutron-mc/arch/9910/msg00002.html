<P><strong><blink>This archive web page is obsolete!</blink></strong> 
<P>Please refer to the new <a href="/pipermail/neutron-mc">mailman<a> archive!


<!-- MHonArc v2.1.0 -->
<!--X-Subject: kw_monitor -->
<!--X-From: Farhi <farhi@ill.fr> -->
<!--X-Date: Tue, 05 Oct 1999 11:39:51 +0200 -->
<!--X-Message-Id: 37F9C767.B04EDB5A@ill.fr -->
<!--X-ContentType: multipart/mixed -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML//EN">
<html>
<head>
<title>kw_monitor</title>
<link rev="made" href="mailto:farhi@ill.fr">
</head>
<body bgcolor="white">
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<A HREF="msg00000.html">Date Prev</A>][<A HREF="msg00003.html">Date Next</A>]
<a href="index.html#00002">[Chronological]</a>
<a href="threads.html#00002">[Thread]</a>
<a href="/cgi-bin/wilma/neutron-mc">[Top]</a>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<H1>kw_monitor</H1>
<HR>
<!--X-Subject-Header-End-->
<UL>
<LI><strong>To</strong>: <strong>Kristian Nielsen &lt;<A HREF="mailto:kristian.nielsen@risoe.dk">kristian.nielsen@risoe.dk</A>&gt;</strong></LI>
<LI><strong>Subject</strong>: <strong>kw_monitor</strong></LI>
<LI><strong>From</strong>: <strong>Farhi &lt;<A HREF="mailto:farhi@ill.fr">farhi@ill.fr</A>&gt;</strong></LI>
<LI>Date: Tue, 05 Oct 1999 11:39:51 +0200</LI>
<LI>Organization: ILL</LI>
</UL>
<!--X-Head-Body-Sep-Begin-->
<HR>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->


Hy Kristian,
<p>Concerning the kw_monitor, I saw you installed it in the unofficial
additions to McStas. It's great, thanks. Anyway, I modified a line at the
begining in order to be able to use more than one of these monitors in
one instrument definition. Could you update this ?
<br>&nbsp;
<p>OUTPUT PARAMETERS (Nsum, psum, p2sum,file,nlines)
<p>I attach the total file as well.
<p>I'm still on the optimizer. I got some problems in computing the adapted
'pi' probability.
<br>For some neutrons, it becomes very big, that makes spikes on instruments
monitors.
<br>The neutrons responsible for this are those whose efficiency is low
(the optimized source should emit few of those, thus their weight is high).
I'm thinking about suppresing them...
<p>Cheers.
<pre>--&nbsp;
Emmanuel FARHI, <A HREF="http://www.ill.fr/tas/people/Farhi.html">http://www.ill.fr/tas/people/Farhi.html</A>&nbsp;&nbsp;&nbsp;&nbsp; \|/ ____ \|/
TAS-Group, Institut Laue-Langevin (ILL) Grenoble&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ~@-/ oO \-@~
Avenue des Martyrs, BP 156, 38042 Grenoble Cedex 9,France&nbsp;&nbsp; /_( \__/ )_\
Work :Tel (33/0) 4 76 20 71 83. Fax (33/0) 4 76 48 39 06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \__U_/
La Grande Arche, Chateau d'Uriage, 38410 Saint Martin d'Uriage 04 76 59 73 94</pre>
&nbsp;
<PRE>
/*******************************************************************************
*
* McStas, version 1.1, released 
*         Maintained by Kristian Nielsen and Kim Lefmann,
*         Risoe National Laboratory, Roskilde, Denmark
*
* Component: kw_monitor
*
* Written by: EF, 17 Sept 1999
*
* A monitor that list all neutron (k,w).
* Output is a 2D matrix of lines [ kx ky kz Omega Intensity DeltaIntensity ]
* stored if a file. The integrated flux is also measured.
*
* INPUT PARAMETERS:
*
* xmin:     Lower x bound of detector opening (m)
* xmax:     Upper x bound of detector opening (m)
* ymin:     Lower y bound of detector opening (m)
* ymax:     Upper y bound of detector opening (m)
* filename: Name of file in which to store the counts (text)
*
* OUTPUT PARAMETERS:
*
* Nsum:    Integrated neutron counts
* psum:    Integrated neutron weight counts
* p2sum:   Integrated second moments
*
*******************************************************************************/

DEFINE COMPONENT kw_monitor
DEFINITION PARAMETERS (xmin, xmax, ymin, ymax, filename)
SETTING PARAMETERS ()
OUTPUT PARAMETERS (Nsum, psum, p2sum,file,nlines)
STATE PARAMETERS (x,y,z,vx,vy,vz,t,s1,s2,p)
DECLARE
  %{
    int nlines;
    int Nsum;
    double psum, p2sum;
    FILE *file;
    double kx, ky, kz, E;
  %}
INITIALIZE
  %{
    psum = 0;
    p2sum = 0;
    Nsum = 0;
    nlines = 0;
    file = fopen(filename, "w");
    if(!file)
    {
       fprintf(stderr, "Error: %s : could not open output file '%s'\n", mccompcurname, filename);
       exit(-1);
    }
    else
    {
       fprintf(file,"# Instrument-source: %s\n", mcinstrument_source);
       mcruninfo_out("# ", file);
       fprintf(file,"# type: array_2d(-1,6) (See end of file for exact dimensions)\n");
       fprintf(file,"# component: %s\n", mccompcurname);
       fprintf(file,"# title: Resolution (\\vec{k},omega) Monitor\n");
       fprintf(file,"# filename: '%s'\n",filename);
       fprintf(file,"# variables: Kx Ky Kz E I I_err\n");
       fprintf(file,"# xvar: (Kx Ky Kz E)\n");
       fprintf(file,"# yvar: (I,I_err)\n");
       fprintf(file,"# xlabel: 'Wavevector [Angs-1], Energie [meV]'\n");
       fprintf(file,"# ylabel: 'Intensity'\n");
    }
  %}
TRACE
  %{
    PROP_Z0;
    if (x&gt;xmin &amp;&amp; x&lt;xmax &amp;&amp; y&gt;ymin &amp;&amp; y&lt;ymax)
    {
      Nsum++;
      psum += p;
      p2sum += p*p;
      nlines++;
      
      kx = V2K*vx;
      ky = V2K*vy;
      kz = V2K*vz;
      E = VS2E*(vx*vx + vy*vy + vz*vz);
      
	fprintf(file, "%g %g %g %g %g %g\n",
		kx, ky, kz, E, p, p*p);
    }
  %}
FINALLY
  %{
    if (file)
    {
       fprintf(file,"# type: array_2d(%i,6)\n",nlines);
       fprintf(file,"# End of (k,omega) resolution block.\n");
       fclose(file);
    }
    DETECTOR_OUT_0D("Resolution_monitor (integrated)", Nsum, psum, p2sum);
  %}
  
MCDISPLAY
%{
  magnify("xy");
  multiline(5, (double)xmin, (double)ymin, 0.0,
               (double)xmax, (double)ymin, 0.0,
               (double)xmax, (double)ymax, 0.0,
               (double)xmin, (double)ymax, 0.0,
               (double)xmin, (double)ymin, 0.0);
%}
END
</PRE>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<HR>
<UL><LI><STRONG>Follow-Ups</STRONG>:
<UL>
<LI><STRONG><A NAME="00003" HREF="msg00003.html">Re: kw_monitor</A></STRONG>
<UL><LI><EM>From:</EM> Kristian Nielsen &lt;kristian.nielsen@risoe.dk&gt;</LI></UL></LI>
</UL></LI></UL>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<LI>Prev by Date:
<STRONG><A HREF="msg00000.html">McStas graphical front-end and PgPerl solutions</A></STRONG>
</LI>

<LI>Next by Date:
<STRONG><A HREF="msg00003.html">Re: kw_monitor</A></STRONG>
</LI>

<li>Index(es):
<ul>
<li><a href="index.html#00002"><strong>Chronological</Strong></a></li>
<li><a href="threads.html#00002"><strong>Thread</strong></a></li>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</BODY>
</HTML>
