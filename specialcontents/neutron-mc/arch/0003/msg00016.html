<P><strong><blink>This archive web page is obsolete!</blink></strong> 
<P>Please refer to the new <a href="/pipermail/neutron-mc">mailman<a> archive!


<!-- MHonArc v2.1.0 -->
<!--X-Subject: Re: IN6 Monochromators -->
<!--X-From: Kristian Nielsen <kristian.nielsen@risoe.dk> -->
<!--X-Date: 7 Mar 2000 10:07:32 +0100 -->
<!--X-Message-Id:  -->
<!--X-ContentType: multipart/mixed -->
<!--X-Reference-Id: 38C3DE33.E3B686C2@ill.fr -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML//EN">
<html>
<head>
<title>Re: IN6 Monochromators</title>
<link rev="made" href="mailto:kristian.nielsen@risoe.dk">
</head>
<body bgcolor="white">
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<A HREF="msg00017.html">Date Prev</A>][<A HREF="msg00001.html">Date Next</A>]
<a href="index.html#00016">[Chronological]</a>
<a href="threads.html#00016">[Thread]</a>
<a href="/cgi-bin/wilma/neutron-mc">[Top]</a>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<H1>Re: IN6 Monochromators</H1>
<HR>
<!--X-Subject-Header-End-->
<UL>
<LI><strong>To</strong>: <strong><A HREF="mailto:poehlman@ill.fr">poehlman@ill.fr</A></strong></LI>
<LI><strong>Subject</strong>: <strong>Re: IN6 Monochromators</strong></LI>
<LI><strong>From</strong>: <strong>Kristian Nielsen &lt;<A HREF="mailto:kristian.nielsen@risoe.dk">kristian.nielsen@risoe.dk</A>&gt;</strong></LI>
<LI>Date: 7 Mar 2000 10:07:32 +0100</LI>
<LI>CC: <A HREF="mailto:schober@ill.fr">schober@ill.fr</A></LI>
<LI>In-reply-to: &lt;<A HREF="msg00017.html">38C3DE33.E3B686C2@ill.fr</A>&gt; (message from Markus Poehlmann on Mon,06 Mar 2000 17:34:59 +0100)</LI>
</UL>
<!--X-Head-Body-Sep-Begin-->
<HR>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<PRE>
&gt; Date: Mon, 06 Mar 2000 17:34:59 +0100
&gt; From: Markus Poehlmann &lt;poehlman@ill.fr&gt;

&gt; Now I rotated not the arms but the Mosaic_anisotropics themselves and it
&gt; seems that it works. But in the visualisation with mcdisplay a neutron
&gt; passes still one plate after another and is not propagated before having
&gt; passed each of the seven plates in each of the 3 monochromators.
&gt; Is that only a problem of mcdisplay or is the calculation itsself like
&gt; this ? Our results seem to be correct now.

&gt; Would you plaese find attached the file in62.instr and could you please
&gt; have a look on it in respect to the problem described above.

I took a look, and the monochromator setup seems just fine.

The mcdisplay plots can admittedly be confusing sometimes. However, I am
not quite sure what you mean by "a neutron passes still one plate after
another" in mcdisplay? Are you using McStas version 1.2, or is it an
older version?

I have attached three pictures that show a scattering event so that you
can compare with your plots. I have also attached an updated
"Guide.comp" file that allows mcdisplay to show all reflections in the
guide. Also note that the "Bender" component is a little quirky in
mcdisplay because of its non-standard use of geometry.

 - Kristian.

--
Kristian Nielsen        kristian.nielsen@risoe.dk
Risø National Laboratory
Condensed Matter Physics and Chemistry Department
Tel. +45 4677 5515   Fax +45 4677 4790
Encryption PGP key <A HREF="http://neutron.risoe.dk/kn.txt">http://neutron.risoe.dk/kn.txt</A>

</PRE>
<P><A HREF="gif00000.gif"><IMG SRC="gif00000.gif" ALT="GIF image"></A></P>
<P><A HREF="gif00001.gif"><IMG SRC="gif00001.gif" ALT="GIF image"></A></P>
<P><A HREF="gif00002.gif"><IMG SRC="gif00002.gif" ALT="GIF image"></A></P>
<PRE>
/*******************************************************************************
*
* McStas, the neutron ray-tracing package
*         Maintained by Kristian Nielsen and Kim Lefmann,
*         Copyright 1997-2000 Risoe National Laboratory, Roskilde, Denmark
*
* %I
* Written by: KN
* Date: September 2 1998
* Version: $Revision: 1.1.1.1 $
* Origin: McStas release
* Modified by: KL, October 6, 1998
*
* Neutron guide.
*
* %D
* Models a rectangular guide tube centered on the Z axis. The entrance lies
* in the X-Y plane.
* For details on the geometry calculation see the description in the McStas
* reference manual.
*
* %P
* INPUT PARAMETERS:
*
* w1:      (m)    Width at the guide entry
* h1:      (m)    Height at the guide entry
* w2:      (m)    Width at the guide exit
* h2:      (m)    Height at the guide exit
* l:       (m)    length of guide
* R0:      (1)    Low-angle reflectivity
* Qc:      (AA-1) Critical scattering vector
* alpha:   (AA)   Slope of reflectivity
* m:       (1)    m-value of material. Zero means completely absorbing.
* W:       (AA-1) Width of supermirror cut-off
*
* %D
* Example values: m=4 Qc=0.02 W=1/300 alpha=6.49 R0=1
*
* %E
*******************************************************************************/

DEFINE COMPONENT Guide
DEFINITION PARAMETERS (w1, h1, w2, h2, l, R0, Qc, alpha, m, W)
SETTING PARAMETERS ()
STATE PARAMETERS (x,y,z,vx,vy,vz,t,s1,s2,p)

TRACE
%{
  double t1,t2;                                 /* Intersection times. */
  double av,ah,bv,bh,cv1,cv2,ch1,ch2,d;         /* Intermediate values */
  double vdotn_v1,vdotn_v2,vdotn_h1,vdotn_h2;   /* Dot products. */
  int i;                                        /* Which mirror hit? */
  double q;                                     /* Q [1/AA] of reflection */
  double vlen2,nlen2;                           /* Vector lengths squared */

  /* ToDo: These could be precalculated. */
  double ww = .5*(w2 - w1), hh = .5*(h2 - h1);
  double whalf = .5*w1, hhalf = .5*h1;
  double lwhalf = l*whalf, lhhalf = l*hhalf;

  /* Propagate neutron to guide entrance. */
  PROP_Z0;
  if(x &lt;= -whalf || x &gt;= whalf || y &lt;= -hhalf || y &gt;= hhalf)
    ABSORB;
  for(;;)
  {
    /* Compute the dot products of v and n for the four mirrors. */
    av = l*vx; bv = ww*vz;
    ah = l*vy; bh = hh*vz;
    vdotn_v1 = bv + av;         /* Left vertical */
    vdotn_v2 = bv - av;         /* Right vertical */
    vdotn_h1 = bh + ah;         /* Lower horizontal */
    vdotn_h2 = bh - ah;         /* Upper horizontal */
    /* Compute the dot products of (O - r) and n as c1+c2 and c1-c2 */
    cv1 = -whalf*l - z*ww; cv2 = x*l;
    ch1 = -hhalf*l - z*hh; ch2 = y*l;
    /* Compute intersection times. */
    t1 = (l - z)/vz;
    i = 0;
    if(vdotn_v1 &lt; 0 &amp;&amp; (t2 = (cv1 - cv2)/vdotn_v1) &lt; t1)
    {
      t1 = t2;
      i = 1;
    }
    if(vdotn_v2 &lt; 0 &amp;&amp; (t2 = (cv1 + cv2)/vdotn_v2) &lt; t1)
    {
      t1 = t2;
      i = 2;
    }
    if(vdotn_h1 &lt; 0 &amp;&amp; (t2 = (ch1 - ch2)/vdotn_h1) &lt; t1)
    {
      t1 = t2;
      i = 3;
    }
    if(vdotn_h2 &lt; 0 &amp;&amp; (t2 = (ch1 + ch2)/vdotn_h2) &lt; t1)
    {
      t1 = t2;
      i = 4;
    }
    if(i == 0)
      break;                    /* Neutron left guide. */
    PROP_DT(t1);
    switch(i)
    {
      case 1:                   /* Left vertical mirror */
        nlen2 = l*l + ww*ww;
        q = V2Q*(-2)*vdotn_v1/sqrt(nlen2);
        d = 2*vdotn_v1/nlen2;
        vx = vx - d*l;
        vz = vz - d*ww;
        break;
      case 2:                   /* Right vertical mirror */
        nlen2 = l*l + ww*ww;
        q = V2Q*(-2)*vdotn_v2/sqrt(nlen2);
        d = 2*vdotn_v2/nlen2;
        vx = vx + d*l;
        vz = vz - d*ww;
        break;
      case 3:                   /* Lower horizontal mirror */
        nlen2 = l*l + hh*hh;
        q = V2Q*(-2)*vdotn_h1/sqrt(nlen2);
        d = 2*vdotn_h1/nlen2;
        vy = vy - d*l;
        vz = vz - d*hh;
        break;
      case 4:                   /* Upper horizontal mirror */
        nlen2 = l*l + hh*hh;
        q = V2Q*(-2)*vdotn_h2/sqrt(nlen2);
        d = 2*vdotn_h2/nlen2;
        vy = vy + d*l;
        vz = vz - d*hh;
        break;
    }
    /* Now compute reflectivity. */
    if(m == 0)
      ABSORB;
    if(q &gt; Qc)
    {
      double arg = (q-m*Qc)/W;
      if(arg &lt; 10)
        p *= .5*(1-tanh(arg))*(1-alpha*(q-Qc));
      else
        ABSORB;                               /* Cutoff ~ 1E-10 */
    }
    p *= R0;
    SCATTER;
  }
%}

MCDISPLAY
%{
  double x;
  int i;

  magnify("xy");
  multiline(5,
            -w1/2.0, -h1/2.0, 0.0,
             w1/2.0, -h1/2.0, 0.0,
             w1/2.0,  h1/2.0, 0.0,
            -w1/2.0,  h1/2.0, 0.0,
            -w1/2.0, -h1/2.0, 0.0);
  multiline(5,
            -w2/2.0, -h2/2.0, (double)l,
             w2/2.0, -h2/2.0, (double)l,
             w2/2.0,  h2/2.0, (double)l,
            -w2/2.0,  h2/2.0, (double)l,
            -w2/2.0, -h2/2.0, (double)l);
  line(-w1/2.0, -h1/2.0, 0, -w2/2.0, -h2/2.0, (double)l);
  line( w1/2.0, -h1/2.0, 0,  w2/2.0, -h2/2.0, (double)l);
  line( w1/2.0,  h1/2.0, 0,  w2/2.0,  h2/2.0, (double)l);
  line(-w1/2.0,  h1/2.0, 0, -w2/2.0,  h2/2.0, (double)l);
%}

END
</PRE>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<HR>
<!--X-Follow-Ups-End-->
<!--X-References-->
<UL><LI><STRONG>References</STRONG>:
<UL>
<LI><STRONG><A NAME="00017" HREF="msg00017.html">IN6 Monochromators</A></STRONG>
<UL><LI><EM>From:</EM> Markus Poehlmann &lt;poehlman@ill.fr&gt;</LI></UL></LI>
</UL></LI></UL>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<LI>Prev by Date:
<STRONG><A HREF="msg00017.html">IN6 Monochromators</A></STRONG>
</LI>

<LI>Next by Date:
<STRONG><A HREF="msg00001.html">New tested components for McStas</A></STRONG>
</LI>

<li>Index(es):
<ul>
<li><a href="index.html#00016"><strong>Chronological</Strong></a></li>
<li><a href="threads.html#00016"><strong>Thread</strong></a></li>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</BODY>
</HTML>
