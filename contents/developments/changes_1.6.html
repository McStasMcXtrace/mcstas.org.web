<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type"
 content="text/html; charset=iso-8859-1">
  <meta name="GENERATOR"
 content="Mozilla/4.77 [en] (X11; U; Linux 2.2.19 i686) [Netscape]">
  <title>McStas 1.6: changes</title>
</head>
<body alink="#ff0000" bgcolor="#ffffff" link="#0000ef" text="#000000"
 vlink="#51188e">
<h3 style="text-align: center;">
Changes in version 1.6 <span style="font-style: italic;">alpha dev</span>
(October 29th, 2001)</h3>
<div style="text-align: center;">[ <a href="#kernel">kernel</a> ][ <a
 href="#tools">tools</a> ][ <a href="#Updated">modified components</a>
][ <a href="#New">new components</a> ]</div>
<br>
<ul>
  <li><a name="kernel"></a><span style="font-weight: bold;">Kernel/language</span></li>
  <ul>
    <li><span style="font-weight: bold;">SHARE:</span> In component
definitions, a <span style="font-weight: bold;">SHARE </span>keyword
followed by a C code block&nbsp; <br>
&nbsp;&nbsp; %{...}% acts the same as a DECLARE block, but is only
included once in an<br>
&nbsp;&nbsp; instrument. This is very useful when using many identical
components<br>
&nbsp;&nbsp; (guides, monitors, monochromators) to speed-up compiling
and perfomrnaces.<br>
&nbsp;&nbsp;&nbsp;&nbsp; SHARE <br>
&nbsp;&nbsp;&nbsp;&nbsp; %{ /* included only once for all identical
components */<br>
&nbsp;&nbsp;&nbsp;&nbsp; %}<br>
&nbsp;&nbsp;&nbsp;&nbsp; DECLARE<br>
&nbsp;&nbsp;&nbsp;&nbsp; %{ /* included for all components */<br>
&nbsp;&nbsp;&nbsp;&nbsp; %}<br>
&nbsp;&nbsp; Then all component programmers may add C functions to the
'kernel'. This is<br>
&nbsp;&nbsp; only worth when you plan to use a given component many
times in a simulation<br>
&nbsp;&nbsp; (e.g. not for sources or samples). To downgrade a McStas
1.5 component, just<br>
&nbsp;&nbsp; move the SHARE block C code into the DECLARE block. <br>
    </li>
    <li><span style="font-weight: bold;">EXTEND: </span>In an
instrument definition, within the TRACE section, each COMPONENT <br>
&nbsp;&nbsp; instance may include a C code block:<br>
&nbsp;&nbsp;&nbsp;&nbsp; COMPONENT Comp1 = Guide(...)<br>
&nbsp;&nbsp;&nbsp;&nbsp; AT (...) ROTATED (...)<br>
&nbsp;&nbsp;&nbsp;&nbsp; EXTEND <br>
&nbsp;&nbsp;&nbsp;&nbsp; %{ /* some C code to execute after component
Comp1 */<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* in current coordinate
system. You may use Comp1 and global */<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* instrument variables */<br>
&nbsp;&nbsp;&nbsp;&nbsp; %}<br>
&nbsp;&nbsp; For instance, you can here give a 'color' (additional
neutron&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp; characteristic) and modify next components behaviours.<br>
&nbsp;&nbsp; This block is always executed in groups, but you can test
if the component</li>
    <li><span style="font-weight: bold;">GROUP:</span> In an instrument
TRACE section, it is possible to put a set of component<br>
&nbsp;&nbsp; in an exclusive group. Only one of the elements of the
group can act on<br>
&nbsp;&nbsp; the neutron. If no element acts on the neutron, it is
absorbed.<br>
&nbsp;&nbsp; This is specially useful for multi-detectors,
multi-monochromators in <br>
&nbsp;&nbsp; parallel, multiple collimators/guides (e.g. radial).<br>
&nbsp;&nbsp;&nbsp;&nbsp; COMPONENT Comp1 = Guide(...)<br>
&nbsp;&nbsp;&nbsp;&nbsp; AT (...) ROTATED (...) GROUP MyGroupName<br>
&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp; COMPONENT Comp2 = Guide(...)<br>
&nbsp;&nbsp;&nbsp;&nbsp; AT (...) ROTATED (...) GROUP MyGroupName<br>
&nbsp;&nbsp; Comp1 and Comp2 may even be at the same place. <br>
&nbsp;&nbsp; For programmers: it is important that the component TRACE
section contains a<br>
&nbsp;&nbsp; SCATTER keyword when it successfully intercepts it, to
tell McStas that a<br>
&nbsp;&nbsp; component in a group acts on a neutron, and can skip other
comp in the group.</li>
  </ul>
  <li style="font-weight: bold;">Library/functionalities at <a
 name="run-time"></a>run-time</li>
  <ul>
    <li>The <span style="font-weight: bold;">signal handler</span> now
gives more info about where a signal was caught.<br>
&nbsp;&nbsp; For instance it tells in which component part an error
occured, to make<br>
&nbsp;&nbsp; debuging easier.<br>
&nbsp;&nbsp; Usefull Signals: kill -Signal &lt;pid&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -USR1: display info and continue
simulation<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -USR2: finish simulation and save results<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -QUIT: end simulation immediately</li>
    <li>The 2D detectors now also output the errors/counts on signal as
1D detectors.<br>
&nbsp;&nbsp; Set p2=NULL in DETECTOR_OUT_2D to unactivate error saving
in components.</li>
    <li>There are now new MACROS for the component programmer.<br>
&nbsp;&nbsp;&nbsp;&nbsp; * mccompcurindex is the number (index) of the
current component <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (1 is first component of
instrument)<br>
&nbsp;&nbsp;&nbsp;&nbsp; * RESTORE_NEUTRON(index, x, y, z, vx, vy, vz,
t, sx, sy, sz, p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; restores the neutron state to the
one at the input of the component<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'index'. To ignore a component
effect, use<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RESTORE_NEUTRON(mccompcurindex, x,
y, z, vx, vy, vz, t, sx, sy, sz, p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at the end of its TRACE section,
or in its EXTEND section.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; These neutron states are in the
local component coordinate systems.<br>
&nbsp;&nbsp;&nbsp;&nbsp; * STORE_NEUTRON(index, x, y, z, vx, vy, vz, t,
sx, sy, sz, p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stores the current neutron state
in the trace-history table, in local<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coordinate system. This is
automatically done when entering each<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; component of an instrument.<br>
&nbsp;&nbsp;&nbsp;&nbsp; * POS_A_COMP_INDEX(index) is the absolute
position of component<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'index'.
POS_A_COMP_INDEX(mccompcurindex) is the same as<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; POS_A_CURRENT_COMP. You may use
POS_A_COMP_INDEX(mccompcurindex+1) to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; make, for instance, your component
access the position of the next<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; component (this is usefull for
automatic targeting).<br>
&nbsp;&nbsp;&nbsp;&nbsp; * SCATTERED is non zero when previous
component acted on neutron (let pass<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; or scatter)</li>
    <li><span style="color: rgb(255, 0, 0); font-weight: bold;">Warning:</span><span
 style="font-weight: bold;"> </span>programmers, do not use anymore
the 'mccompcurname' when writing<br>
&nbsp;&nbsp; your components. rather use the 'NAME_CURRENT_COMP'.<br>
    </li>
  </ul>
  <li style="font-weight: bold;">McStas <a name="tools"></a>tools
(mcrun, mcplot, mcgui, etc...)</li>
  <ul>
    <li>In <span style="font-weight: bold;">'mcplot',</span> it is
possible to use the -ps, -psc and -gif options to<br>
&nbsp;&nbsp; generate a PS, color PS, and GIF file, and exit mcplot (no
display).</li>
  </ul>
  <li style="font-weight: bold;"><a name="Updated"></a>Updated/modified
components</li>
  <ul>
    <li>The <span style="font-weight: bold;">Monitor_nD</span> was
upgraded to correct bugs when reaching the component<br>
&nbsp;&nbsp; (the propagation was not performed correctly in some
cases), and the disk/<br>
&nbsp;&nbsp; sphere radius (monitor remained then squared). This
component now uses<br>
&nbsp;&nbsp; the SHARE block. A bug was corrected for lists. It can
output log and abs of<br>
&nbsp;&nbsp; signals, and source files (see Source_file).</li>
    <li>The <span style="font-weight: bold;">Gravity_guide</span> now
handles correctly the focusing multichannel guides.<br>
&nbsp;&nbsp; Gravitation is included (on y axis). This component now
uses the SHARE block.<br>
&nbsp;&nbsp; The Channeled_guide does not handle properly the focusing
multichannels.</li>
    <li>Moved to <span style="font-weight: bold;">obsolete</span>
components (usually because they awere renamed):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; monitors:
PSD_monitor_4PI_log.comp, PSD_bidim.comp, PSD_curved.comp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PSD_entry.comp,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; samples: Powder0.comp<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; optics:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Beamstop_circular Beamstop_rectangular (gathered into Beamstop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
First_Chopper (included in Chopper)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Circular_slit (included in Slit)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Guide2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Monochromator0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Circular_slit<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Soller_trans.comp</li>
    <li>tested and corrected components</li>
    <ul>
      <li>misc: Vitess_input/output: included Spin from Vitess.
(vitess-lib.c/h)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; but can not be
used as mcstas can not find vitess-lib.c/h. I included<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; what was needed
in SHARE sections. now works OK.</li>
      <li>samples:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Single_crystal (now can take lattice angles, forgot a %} at SHARE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
end) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
provide *.dat diffraction samples from Crystallographic<br>
      </li>
      <li>optics:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Beamstop now is a merging of Beamstop_circular and <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Beamstop_rectangular (using default&nbsp; values to select shape)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Channeled_guide: now output an error in multichannel focusing mode.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Chopper: determined default values to have lambda~4 AA. Can handle<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
First_Chopper (parameter IsFirst)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Fermi_Chopper : default values for transmission every ~2 AA<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Gravity_guide: limit loops to max of 1000 bounces for each <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
components (to avoid endless loops)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Mosaic_anisotropic: can take DM (d-spacing). default for graphite.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Powder_filter (did not work at all, now can take lattice angles, <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
also works as a sample, can take samples/*.dat diffraction files)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Selector: default values for transmission at ~4 AA<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Slit: now is a merging of Slit and Circular_slit (using default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
values to select shape)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Soller: can take transmission<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
V_selector: default values for transmission at ~4 AA<br>
      </li>
      <li>sources<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Source_gen: can handle all previous sources in one component (up to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 Maxwellians). Corrected homogeneity bug for illumination.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Source_file: can read 'source' files from Vitess, text files (both <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
90 bytes/neutron) and float binary&nbsp; files (e.g, from Monitor_nD <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
with options="list all, source binary" which is more compact in&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
size, 48&nbsp; bytes/neutron). Autorecognition of the format. The MCNP <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
output is not fixed. Just tell MCNP&nbsp; guys to output the float <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
binary or text file.<br>
      </li>
    </ul>
  </ul>
  <li style="font-weight: bold;"><a name="New"></a>New components</li>
  <ul>
    <li>The <span style="font-weight: bold;">Source_gen</span>
component focuses uniformly on the target, and can model<br>
&nbsp;&nbsp; rectangular, disk, gaussian, and Maxwellian (up to 3
distributions) sources. <br>
&nbsp;&nbsp; Previous source components did not focus correctly on the
target. They were <br>
&nbsp;&nbsp; also corrected, execpt the 'Source_Maxwell'. Source_gen
can replace all thee<br>
&nbsp;&nbsp; previous sources.</li>
    <li>A new Source_file component can take as input a text file
containing an<br>
&nbsp;&nbsp; array with columns ' x y z vx vy vz t sx sy sz p', such as
the data files<br>
&nbsp;&nbsp; generated from Monitor_nD with options="list all source".
The source may<br>
&nbsp;&nbsp; be re-generated more than once, which is useful to improve
accuracy,<br>
&nbsp;&nbsp; specially when further components do MC choices. Vitess
files and float<br>
&nbsp;&nbsp; binary files are also ok (auto-recognition of format).</li>
    <li>We tried to lower the number of components by merging similar
ones. <br>
    </li>
  </ul>
</ul>
<hr width="100%">
<center><i>Last modified October 31, 2001 by Per-Olof &Aring;strand</i></center>
</body>
</html>
