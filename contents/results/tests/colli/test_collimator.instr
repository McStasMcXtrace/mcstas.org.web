% Test of the collimator and slit components.
%

DEFINE INSTRUMENT test_collimator(divergence, phi, theta)

DECLARE
%{

/* Number of neutrons to send through. */
#define RUNNUM 100000
int run_num;

/* Global correction factor */
double MC_correction;

char *PSD_name = "testresults/collimator.psd";
char *PSD_4pi_name = "testresults/collimator_4pi.psd";

/* Our main() function. */
int
main(int argc, char *argv[])
{
  mcreadparams();
  srandom(time(NULL));
  mcinit();
  while(run_num < RUNNUM)
  {
    mcsetstate(0, 0, 0, 0, 0, 1, 0, 0, 0, 1);
    mcraytrace();
    run_num++;
  }
  mcfinally();
  return 0;
}

%}

INITIALIZE
%{
  MC_correction = 1;  /* Scale factor is initially unity */
  run_num = 0;         /* Initialize mc neutron counter. */
%}

COMPONENT a1 = Axis()
  AT (0,0,0) ABSOLUTE

COMPONENT source = Source_aim(radius=0.1,
			  dist=1001,
		          xw=0.2, yh=0.2, 
			  v0=1000, dv=200)
  AT (0,0,-1000) RELATIVE a1
  ROTATED (0,0,0) RELATIVE a1

COMPONENT slit1 = Slit(xmin = -0.05, xmax = 0.05, ymin = -0.05, ymax = 0.05)
  AT (0,0,1) RELATIVE a1 ROTATED (0,0,0) RELATIVE a1

COMPONENT PSD = PSD_monitor(xmin=-0.1, xmax=0.1,
          ymin =-0.1, ymax=0.1, nx=100, ny=100,
         PSD_p=EXTERN PSD_p, PSD_N=EXTERN PSD_N,
         m1x=EXTERN PSD_m1x, m1y=EXTERN PSD_m1y, m2x=EXTERN PSD_m2x, m2y=EXTERN PSD_m2y,
	 filename=EXTERN PSD_name)
  AT (0,0,1) RELATIVE a1
  ROTATED (0,0,0) RELATIVE a1

COMPONENT coll = Collimator(xmin = -0.1, xmax = 0.1, ymin = -0.1,
			    ymax = 0.1, divergence = divergence)
  AT (0,0,2) RELATIVE a1 ROTATED (theta, phi, 0) RELATIVE a1

COMPONENT slit2 = Slit(xmin = -0.05, xmax = 0.05, ymin = -0.05, ymax = 0.05)
  AT (0,0,3) RELATIVE a1 ROTATED (0,0,0) RELATIVE a1

COMPONENT SNG = Monitor(xmin = -0.1, xmax=0.1, ymin =-0.15, ymax=0.15,
			    psum = EXTERN SNG_p, Nsum = EXTERN SNG_N)
     AT (0,0,3) RELATIVE a1 ROTATED (0,0,0) RELATIVE a1

COMPONENT PSD_4pi = PSD_monitor_4PI(radius=2000, nx=101, ny=51,
         PSD_p=EXTERN PSD_2pi_p, PSD_N=EXTERN PSD_2pi_N,
	 filename=EXTERN PSD_4pi_name)
  AT (0,0,0) RELATIVE a1 ROTATED (0,0,0) RELATIVE a1

FINALLY
%{
  printf("Finished simulation of %d neutrons.\n", run_num);
  printf("Correction factor: %g \n",MC_correction);
/*   printf("Moments: %g %g %g %g\n", PSD_m1x, PSD_m2x, PSD_m1y, PSD_m2y); */
%}

END
