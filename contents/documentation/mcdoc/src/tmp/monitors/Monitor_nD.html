<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML><HEAD>
<TITLE>Monitor_nD</TITLE>
<LINK REV="made" HREF="mailto:kristian.nielsen@risoe.dk">
</HEAD>

<BODY>

<P ALIGN=CENTER>
 [ <A href="#id">Identification</A>
 | <A href="#desc">Description</A>
 | <A href="#ipar">Input parameters</A>
 | <A href="#opar">Output parameters</A>
 | <A href="#links">Links</A> ]
</P>

<H1>The <CODE>Monitor_nD</CODE> component</H1>

This component is a general Monitor that can output 0/1/2D signals 
(Intensity vs. [something] and vs. [something] ...)


<H2><A NAME=id></A>Identification</H2>

<UL>
  <LI> <B>Author:</B> <a href="mailto:farhi@ill.fr">Emmanuel Farhi</a></B>
  <LI> <B>Origin:</B> McStas 1.6/<a href="http://www.ill.fr">ILL</a></B>
  <LI> <B>Date:</B> 14th Feb 2000.</B>
  <LI> <B>Version:</B> 0.16.4</B>
  <LI> <B>Modification history:</B> <UL>
    <LI>  EF, 29th Feb 2000 : added more options, monitor shape, theta, phi
    <LI>  EF, 10th Mar 2000 : use struct. 
    <LI>  EF, 25th May 2000 : correct Vars.Mon2D_Buffer alloc bug.
    <LI>  EF, 17th Oct 2000 : spin detector ok. (0.13.4)
    <LI>  EF, 19th Jan 2001 : 'auto limits' bug corrected (0.13.5)
    <LI>  EF, 01st Feb 2001 : PreMonitor for correlation studies (0.13.6)
    <LI>  EF, 02nd Feb 2001 : user variable (0.13.7)
    <LI>  EF, 2th  Feb 2001 : 3He gas absorption handling (0.13.8)
    <LI>  EF, 5th  Mar 2001 : intermediate savings (0.13.9)
    <LI>  EF, 5th  Apr 2001 : use global functions (0.14) compile faster
    <LI>  EF, 18th Apr 2001 : passes DETECTOR_OUT to mcdetector_out 0.14.1
    <LI>  EF, 23th Jul 2001 : log of signal, init arrays to 0, box (0.15)
    <LI>  EF, 04th Sep 2001 : log/abs of variables (0.16)
    <LI>  EF, 19th Sep 2001 : correct PROP_ZO and disk bug. McStas 1.6.
    <LI>  EF, 28th Sep 2001 : intermediate 'source' option. bug for list ok
    <LI>  EF, 24th Oct 2001 : capture flux  [p*lambda/1.7985] (0.16.3)
    <LI>  EF, 15th Feb 2002 : corrected bug in auto regeneration (0.16.4)
  </UL>
</UL>
<H2><A NAME=desc></A>Description</H2>

<PRE>
This component is a general Monitor that can output 0/1/2D signals 
It can produce many 1D signals (one for any variable specified in 
option list), or a single 2D output (two variables correlation).
Also, an additional 'list' of neutrons can be produced.
By default, monitor is square (in x/y plane). disk is also possible
The 'cylinder' option will change that for banana shaped detector
The 'sphere' option simulates spherical detector. The 'box' is a box.
The monitored flux may be per monitor unit area, and weighted by
a lambda/lambda(2200m/s) factor to obtain standard capture flux.
In normal configuration, the Monitor_nD measures the current parameters 
of the neutron that is beeing detected. But a PreMonitor_nD component can 
be used in order to study correlations between a neutron being detected in
a Monitor_nD place, and given parameters that are monitored elsewhere 
(at <b>PreMonitor_nD</b>).
It is also possible, using the 'intermediate' keyword, to save monitor results
every X percent of the simulation. The monitor can also act as a 3He gas
detector, taking into account the detection efficiency.
To create an intermediate 'source' file collecting all neutron states, use:
  COMPONENT MySourceCreator = Monitor_nD(
    filename = "MySource.list", options="list all, source")
The output file is text formatted with: [x y z vx vy vz t sx sy sz p] lines, 
and is about 85 byte per neutron. May be half size with 'binary' option.

<b>Possible options are</b>
Variables to record:
    kx ky kz k wavevector (Angs-1) [    usually axis are
    vx vy vz v            (m/s)         x=horz., y=vert., z=on axis]
    x y z radius          (m)      Distance, Position
    t time                (s)      Time of Flight
    energy omega          (meV)
    lambda wavelength     (Angs)
    p intensity flux      (n/s) or (n/cm^2/s)
    ncounts               (1)
    sx sy sz              (1)      Spin
    vdiv ydiv dy          (deg)    vertical divergence (y)
    hdiv divergence xdiv  (deg)    horizontal divergence (x)
    angle                 (deg)    divergence from <z> direction
    theta longitude       (deg)    longitude (x/z) [for sphere and cylinder]
    phi   lattitude       (deg)    lattitude (y/z) [for sphere and cylinder]

    user user1            will monitor the [Mon_Name]_Vars.UserVariable{1|2}
    user2                 to be assigned in an other component (see below)

<b>Other options are:</b>
    abs                       Will monitor the abs of the following variable
                              or of the signal (if used after variables)
    auto                      Automatically set detector limits
    all  {limits or bins}     To set all limits or bins values
    binary                    with 'source' option, saves in compact files
    bins=[bins=20]            Number of bins in the detector along dimension
    borders                   To also count off-limits neutrons
                               (X < min or X > max)
    capture                   weight by lambda/lambda(2200m/s) capture flux
    file=string               Detector image file name. default is component
                               name, plus date and variable extension.
    intermediate=[5 in %]     Save results every n% steps in simulation
    limits=[min max]          Lower/Upper limits for axes
                               (see up for the variable unit)
    list=[counts=1000] or all For a long file of neutron characteristics
                               with [counts] or all events
    log                       Will monitor the log10 of the following variable
                              or of the signal (if used after variables)
    multiple                  For 1D monitors into multiple independant files
    no or not                 Revert next option
    outgoing                  Monitor outgoing beam in non flat (sph/cyl) det
                               (default is incoming beam)
    parallel                  Use this option when the next component is at 
                               the same position (parallel components)
    per cm2                   Intensity will be per cm^2
    premonitor                Will monitor neutron parameters stored
                               previously with <b>PreMonitor_nD</b>.
    slit or absorb            Absorb neutrons that are out detector
    source                    The monitor will save neutron states
    unactivate                To unactivate detector (0D detector)
    verbose                   To display additional informations
    3He_pressure=[3 in bars]  The 3He gas pressure in detector.
                              3He_pressure=0 means perfect detector (default)

Detector shape options (specified as xwidth, yheight, zthick or x/y/z/min/max)
    box                       Box of size xwidth, yheight, zthick
    cylinder                  To get a cylindrical monitor (e.g. banana)
                               (radius is xwidth, height is yheight).
    disk                      Disk flat xy monitor. radius is xwidth.
    sphrere                   To get a spherical monitor (e.g. a 4PI)
                               (radius is xwidth).
    square                    Square flat xy monitor (xwidth, yheight)

<b>EXAMPLES:</b>
MyMon = Monitor_nD(
  xwidth = 0.1, yheight = 0.1, zthick = 0,
  options = "intensity per cm2 angle,limits=[-5 5] bins=10,with
             borders, file = mon1");
                          will monitor neutron angle from [z] axis, between -5
                       and 5 degrees, in 10 bins, into "mon1.A" output 1D file
  options = "sphere theta phi outgoing"   for a sphere PSD detector (out beam)
                                   and saves into file "MyMon_[Date_ID].th_ph"
  options = "angle radius auto"   is a 2D monitor with automatic limits
  options = "list kx ky kz energy" records each neutron contribution in 1 file
  options = "multiple kx ky kz energy and list all neutrons" 
         makes 4 output 1D files and produces a complete list for all neutrons

How to monitor anything in my simulation: with the 'user' option
1) put in your instrument DECLARE: struct MonitornD_Variables *InstrVars;
2) put in your instrument INITIALIZE (optionally, to set monitor name):
   InstrVars = &(MC_GETPAR(MyMonitor, Vars));
   strcpy(InstrVars->UserName1,"log xy+1");
3) put just after the component where you want to monitor (to set the value)
 EXTEND
 %{  
   InstrVars = &(MC_GETPAR(MyMonitor, Vars));
   InstrVars->UserVariable1 = log(fabs(x*y+1));
 %}
4) put further in the instrument (to monitor the user1 value defined before)
 COMPONENT MyMonitor = Monitor_nD(
  xwidth = 0.1, yheight = 0.1,
  options="user1, auto")
 AT ...

See also the example in <a href="PreMonitor_nD.html">PreMonitor_nD</a> to
monitor neutron parameters cross-correlations.

</PRE>

<H2><A NAME=ipar></A>Input parameters</H2>
Parameters in <B>boldface</B> are required;
the others are optional.
<TABLE BORDER=1>
<TR><TH>Name</TH>  <TH>Unit</TH>  <TH>Description</TH> <TH>Default</TH></TR>
<TR> <TD>options</TD>
     <TD>str</TD>
     <TD>String that specifies the configuration of the monitor</br>
The general syntax is "[x] options..." (see <b>Descr.</b>)
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>filename</TD>
     <TD></TD> <TD></TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>xwidth</TD>
     <TD>m</TD>
     <TD>Width/diameter of detector (x)
</TD>
<TD ALIGN=RIGHT>.1</TD> </TR>
<TR> <TD>yheight</TD>
     <TD>m</TD>
     <TD>Height of detector (y)
</TD>
<TD ALIGN=RIGHT>.1</TD> </TR>
<TR> <TD>zthick</TD>
     <TD>m</TD>
     <TD>Thichness of detector (z)
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>xmin</TD>
     <TD>m</TD>
     <TD>Lower x bound of opening
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>xmax</TD>
     <TD>m</TD>
     <TD>Upper x bound of opening
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>ymin</TD>
     <TD>m</TD>
     <TD>Lower y bound of opening
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>ymax</TD>
     <TD>m</TD>
     <TD>Upper y bound of opening
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>zmin</TD>
     <TD>m</TD>
     <TD>Lower z bound of opening
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>zmax</TD>
     <TD>m</TD>
     <TD>Upper z bound of opening
</TD>
<TD ALIGN=RIGHT>0</TD> </TR>
</TABLE>


<H2><A NAME=opar></A>Output parameters</H2>
<TABLE BORDER=1>
<TR><TH>Name</TH>  <TH>Unit</TH>  <TH>Description</TH> <TH>Default</TH></TR>
<TR> <TD><B>DEFS</B></TD>
     <TD>struct</TD>
     <TD>structure containing Monitor_nD Defines </TD>
<TD ALIGN=RIGHT>&nbsp;</TD> </TR>
<TR> <TD><B>Vars</B></TD>
     <TD>struct</TD>
     <TD>structure containing Monitor_nD variables </TD>
<TD ALIGN=RIGHT>&nbsp;</TD> </TR>
</TABLE>


<H2><A NAME=links></A>Links</H2>

<UL>
  <LI> <A HREF="Monitor_nD.comp">Source code</A> for <CODE>Monitor_nD.comp</CODE>.
  <LI> <a href="http://www.ill.fr/tas/mcstas/">McStas at ILL</a>
<a href="PreMonitor_nD.html">PreMonitor_nD</a>

</UL>
<HR>
<P ALIGN=CENTER>
 [ <A href="#id">Identification</A>
 | <A href="#desc">Description</A>
 | <A href="#ipar">Input parameters</A>
 | <A href="#opar">Output parameters</A>
 | <A href="#links">Links</A> ]
</P>

<ADDRESS>
Generated automatically by McDoc, Kristian Nielsen
&lt;<A HREF="mailto:kristian.nielsen@risoe.dk">kristian.nielsen@risoe.dk</A>&gt; /
Jul 22 2002
</ADDRESS>
</BODY></HTML>
