<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML><HEAD>
<TITLE>Source_Optimizer</TITLE>
<LINK REV="made" HREF="mailto:kristian.nielsen@risoe.dk">
</HEAD>

<BODY>

<P ALIGN=CENTER>
 [ <A href="#id">Identification</A>
 | <A href="#desc">Description</A>
 | <A href="#ipar">Input parameters</A>
 | <A href="#opar">Output parameters</A>
 | <A href="#links">Links</A> ]
</P>

<H1>The <CODE>Source_Optimizer</CODE> component</H1>

A component that optimizes the neutron flux passing through the
Source_Optimizer in order to have the maximum flux at the 
<b>Monitor_Optimizer</b> position.


<H2><A NAME=id></A>Identification</H2>

<UL>
  <LI> <B>Author:</B> <a href="mailto:farhi@ill.fr">Emmanuel Farhi</a></B>
  <LI> <B>Origin:</B> McStas 1.5/<a href="http://www.ill.fr">ILL (France)</a></B>
  <LI> <B>Date:</B> 17 Sept 1999</B>
  <LI> <B>Version:</B> 0.09</B>
  <LI> <B>Modification history:</B> <UL>
    <LI>  (v 0.06) EF, Feb 2000;
    <LI>  (v.0.07) EF, Mar 10th 2000; (smoothed, parse options). struct
    <LI>  (v.0.08) EF, Oct 12th 2000; optim divergence for v and s
    <LI>  (v.0.09) EF, Mar 13th 2001; bug on div s (SIGFPE /0 )
  </UL>
</UL>
<H2><A NAME=desc></A>Description</H2>

<PRE>
  Principle: The optimizer first (step 1) computes neutron state parameter  
limits passing in the Source_Optimizer, and then (step 2) records a Reference 
source as well as the state (at Source_Optimizer position) of neutrons
reaching Monitor. The optimized source is defined as a fraction of the 
Reference source plus the distribution of 'good' neutrons reaching the 
Monitor. The optimization then starts (step 3), and focuses new neutrons on 
the Monitor_Optimizer. In fact it changes 'bad' neutrons into 'good' ones
(that reach the Monitor), acting on their position, spin and divergence or
velocity. The overall Monitor flux is kept during process. The energy and 
polarisation distributions are kept during optimization as far as possible 
during optimisation. The optimization method considers that all neutron
parameters - (x,y), (vx,vy,vz) or (vx/v2,vy/v2,v2), (sx,sy,sz) or
(sx/s2,sy/s2,s2) - are independent.

  Options: The optimized source can be computed regularly ('continuous'
option) or only once ('not continuous'). The time spent in steps 1 and 2 can
be reduced for a shorter optimization ('auto').  The neutrons passing during
steps 1 and 2 can be smoothed for a better neutron weight distribution
('smooth' option). 

Source_optimizer can be placed at any position where you want to act on the
flux, for instance just after the source.
Monitor_Optimizer should be placed at position(s) to optimize.
I prefer to put one just before the sample.

Default parameters bins, step, and keep are 10, 10%  and 10% respectively.
The option string can be empty (""), which stands for default configuration
that works fine in usual cases:

 options="continuous optimization, auto mode, smooth, SetXY+SetDivV+SetDivS"

<b>Possible options are</b>
    continuous      for continuous source optimization (default).
    verbose         displays optimization process (debug purpose).
    auto            uses the shortest possible 'step 1' and 'step 2'
                    and sets 'step' value as required (default).
    smooth          remove possible spikes generated in
                    steps 1 and 2 (default is smooth).
    unactivate      to unactivate the Optimizer.
    no or not       revert next option
    bins=[value=10] set the Number of cells for sampling neutron states
    step=[value=10] Optimizer step in % of simulation.
    keep=[value=10] Percentage of initial source distribution that is kept
    file=[name]     Filename where to save optimized source distributions
                    (no file is generated if not given. Default ext. is .src)
    SetXY           Keywords to indicate what may be changed during
    SetV            optimisation. Default is position, divergence and spin
    SetS            direction ("SetXY+SetDivV+SetdivS"). Choosing the speed 
    SetDivV         or spin optimization (SetV or SetS) may modify the energy 
    SetDivS         or polarisation distribution (norm of V and S) 
                    as the three components are then independent.

Parameters bins, step and keep can also be entered as optional parameters.

<b>EXAMPLE</b>: I use the following settings 

 optim_s = Source_Optimizer(options="please be clever") (same as empty)
    (...)
 Monitor_Optimizer(xmin=-0.05, xmax=0.05, ymin=-0.05, ymax=0.05,
            optim_comp = optim_s)

A good optimization needs to record enough non optimized neutrons on Monitor
during step 2. Typical enhancement in computation speed is by a factor 20.
This component usually works well.

<b>NOTE:</b> You must be aware that in some cases (SetV and SetS), 
the optimization mightsligtly afect the energy or spin distribution of the 
source. The optimizer tries to do its best anyway.
Also, some 'spikes' may sometime appear in monitor signals in the course of 
the optimization, coming from non-optimized neutrons with original weight.
The 'smooth' option minimises this effect (on by default).

</PRE>

<H2><A NAME=ipar></A>Input parameters</H2>
Parameters in <B>boldface</B> are required;
the others are optional.
<TABLE BORDER=1>
<TR><TH>Name</TH>  <TH>Unit</TH>  <TH>Description</TH> <TH>Default</TH></TR>
<TR> <TD>options</TD>
     <TD>str</TD>
     <TD>string of options. See <b>Description<b> </TD>
<TD ALIGN=RIGHT>0</TD> </TR>
<TR> <TD>bins</TD>
     <TD></TD> <TD></TD>
<TD ALIGN=RIGHT>10</TD> </TR>
<TR> <TD>step</TD>
     <TD></TD> <TD></TD>
<TD ALIGN=RIGHT>0.1</TD> </TR>
<TR> <TD>keep</TD>
     <TD></TD> <TD></TD>
<TD ALIGN=RIGHT>0.1</TD> </TR>
</TABLE>


<H2><A NAME=opar></A>Output parameters</H2>
<TABLE BORDER=1>
<TR><TH>Name</TH>  <TH>Unit</TH>  <TH>Description</TH> <TH>Default</TH></TR>
<TR> <TD><B>DEFS</B></TD>
     <TD>struct</TD>
     <TD>a set of constant values used in the component </TD>
<TD ALIGN=RIGHT>&nbsp;</TD> </TR>
<TR> <TD><B>Vars</B></TD>
     <TD>struct</TD>
     <TD>structure that contains variables used in the component </TD>
<TD ALIGN=RIGHT>&nbsp;</TD> </TR>
</TABLE>


<H2><A NAME=links></A>Links</H2>

<UL>
  <LI> <A HREF="Source_Optimizer.comp">Source code</A> for <CODE>Source_Optimizer.comp</CODE>.
  <LI> <a href="http://www.ill.fr/tas/mcstas/">McStas at ILL</a>
  <LI> <a href="Monitor_Optimizer.html">Monitor_Optimizer</a>

</UL>
<HR>
<P ALIGN=CENTER>
 [ <A href="#id">Identification</A>
 | <A href="#desc">Description</A>
 | <A href="#ipar">Input parameters</A>
 | <A href="#opar">Output parameters</A>
 | <A href="#links">Links</A> ]
</P>

<ADDRESS>
Generated automatically by McDoc, Kristian Nielsen
&lt;<A HREF="mailto:kristian.nielsen@risoe.dk">kristian.nielsen@risoe.dk</A>&gt; /
Jul 22 2002
</ADDRESS>
</BODY></HTML>
